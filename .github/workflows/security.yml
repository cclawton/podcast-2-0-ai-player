name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Run Gradle dependency submission
        uses: gradle/actions/dependency-submission@v4
        with:
          build-root-directory: android

      - name: Run dependency check
        working-directory: android
        run: ./gradlew dependencies --configuration releaseRuntimeClasspath > dependencies.txt
        continue-on-error: true

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: android/dependencies.txt
          retention-days: 30

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

      - name: Check for hardcoded secrets patterns
        run: |
          echo "Checking for potential hardcoded secrets..."

          # Patterns to check (case-insensitive)
          PATTERNS=(
            "api[_-]?key\s*[=:]\s*['\"][^'\"]+['\"]"
            "secret[_-]?key\s*[=:]\s*['\"][^'\"]+['\"]"
            "password\s*[=:]\s*['\"][^'\"]+['\"]"
            "auth[_-]?token\s*[=:]\s*['\"][^'\"]+['\"]"
            "private[_-]?key\s*[=:]\s*['\"][^'\"]+['\"]"
            "sk-[a-zA-Z0-9]{20,}"
            "AIza[0-9A-Za-z\\-_]{35}"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rniE "$pattern" --include="*.kt" --include="*.java" --include="*.xml" --include="*.properties" --include="*.py" . 2>/dev/null | grep -v "test" | grep -v "example" | grep -v ".gradle" | head -5; then
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "::warning::Potential hardcoded secrets found. Please review the output above."
          else
            echo "No hardcoded secrets patterns detected."
          fi

  static-analysis:
    name: Static Analysis (Detekt)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Create Detekt config if not exists
        run: |
          if [ ! -f android/config/detekt/detekt.yml ]; then
            mkdir -p android/config/detekt
            cat > android/config/detekt/detekt.yml << 'EOF'
          build:
            maxIssues: 50
            excludeCorrectable: false
            weights:
              complexity: 2
              formatting: 1
              LongParameterList: 1
              style: 1
              comments: 1

          config:
            validation: true
            warningsAsErrors: false

          processors:
            active: true
            exclude:
              - 'DetektProgressListener'

          console-reports:
            active: true

          output-reports:
            active: true

          complexity:
            active: true
            LongParameterList:
              active: true
              functionThreshold: 6
              constructorThreshold: 8
            LongMethod:
              active: true
              threshold: 60
            ComplexCondition:
              active: true
              threshold: 4
            TooManyFunctions:
              active: true
              thresholdInFiles: 15
              thresholdInClasses: 15

          exceptions:
            active: true
            TooGenericExceptionCaught:
              active: true
              exceptionNames:
                - Error
                - Exception
                - RuntimeException
                - Throwable
            SwallowedException:
              active: true
            ThrowingExceptionsWithoutMessageOrCause:
              active: true

          naming:
            active: true
            FunctionNaming:
              active: true
              excludes: ['**/test/**', '**/androidTest/**']

          performance:
            active: true
            SpreadOperator:
              active: true
            ForEachOnRange:
              active: true

          potential-bugs:
            active: true
            UnsafeCast:
              active: true
            NullableToStringCall:
              active: true

          style:
            active: true
            WildcardImport:
              active: true
              excludeImports:
                - 'kotlinx.android.synthetic.*'
            MagicNumber:
              active: true
              excludes: ['**/test/**', '**/androidTest/**']
              ignoreNumbers:
                - '-1'
                - '0'
                - '1'
                - '2'
            MaxLineLength:
              active: true
              maxLineLength: 120
              excludeCommentStatements: true

          comments:
            active: true
            UndocumentedPublicClass:
              active: false
            UndocumentedPublicFunction:
              active: false
          EOF
          fi

      - name: Check if Detekt is configured in build
        id: check-detekt
        run: |
          if grep -q "detekt" android/build.gradle.kts 2>/dev/null || grep -q "detekt" android/app/build.gradle.kts 2>/dev/null; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Detekt via standalone
        if: steps.check-detekt.outputs.configured == 'false'
        run: |
          # Download detekt CLI
          DETEKT_VERSION="1.23.6"
          curl -sSLO "https://github.com/detekt/detekt/releases/download/v${DETEKT_VERSION}/detekt-cli-${DETEKT_VERSION}.zip"
          unzip -q "detekt-cli-${DETEKT_VERSION}.zip"

          # Run detekt
          ./detekt-cli-${DETEKT_VERSION}/bin/detekt-cli \
            --input android/app/src/main/java \
            --config android/config/detekt/detekt.yml \
            --report html:android/build/reports/detekt/detekt.html \
            --report xml:android/build/reports/detekt/detekt.xml \
            --build-upon-default-config \
            || true

      - name: Run Detekt via Gradle
        if: steps.check-detekt.outputs.configured == 'true'
        working-directory: android
        run: ./gradlew detekt --stacktrace
        continue-on-error: true

      - name: Upload Detekt report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: detekt-report
          path: |
            android/build/reports/detekt/
            android/app/build/reports/detekt/
          retention-days: 14
          if-no-files-found: ignore

  python-security:
    name: Python Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit security scan
        working-directory: mcp-server
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt || true
        continue-on-error: true

      - name: Run Safety dependency check
        working-directory: mcp-server
        run: |
          safety check -r requirements.txt --output json > safety-report.json || true
          safety check -r requirements.txt || true
        continue-on-error: true

      - name: Upload Python security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-reports
          path: |
            mcp-server/bandit-report.json
            mcp-server/safety-report.json
          retention-days: 14
          if-no-files-found: ignore

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan, static-analysis, python-security]
    if: always()

    steps:
      - name: Security Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            echo "| Dependency Scan | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dependency Scan | :warning: Review needed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            echo "| Secret Detection | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Detection | :x: Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.static-analysis.result }}" == "success" ]; then
            echo "| Static Analysis | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Static Analysis | :warning: Review needed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.python-security.result }}" == "success" ]; then
            echo "| Python Security | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Python Security | :warning: Review needed |" >> $GITHUB_STEP_SUMMARY
          fi
